<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Зимние мандарины — Петербург</title>
<style>
body {
    margin: 0;
    background: #000814;
    overflow: hidden;
    font-family: monospace;
}
canvas {
    display: block;
    margin: 0 auto;
    background: linear-gradient(#000814, #001d3d);
    image-rendering: pixelated;
}
</style>
</head>
<body>

<canvas id="game" width="360" height="520"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
ctx.imageSmoothingEnabled = false;

// ───── СОСТОЯНИЕ ─────
let player, mandarins, snowflakes, lives, score;
let gameOver = false;
let gameStarted = false;

function resetGame() {
    player = { x: 150, y: 350, w: 36, h: 90, speed: 3 };
    mandarins = [];
    snowflakes = [];
    lives = 5;
    score = 0;
    gameOver = false;
}
resetGame();

// ───── УПРАВЛЕНИЕ ─────
let keys = {};
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

// ───── ФОН: КАЗАНСКИЙ СОБОР (8-БИТ) ─────
function drawCathedral() {
    // купол
    ctx.fillStyle = "#1c2a3a";
    ctx.beginPath();
    ctx.arc(180, 210, 70, Math.PI, 0);
    ctx.fill();

    ctx.fillStyle = "#2f3e4e";
    ctx.fillRect(110, 210, 140, 50);

    // колоннада
    for (let i = 0; i < 9; i++) {
        ctx.fillStyle = "#3a4a5a";
        ctx.fillRect(70 + i * 28, 260, 10, 80);
    }

    // фасад
    ctx.fillStyle = "#2b3a48";
    ctx.fillRect(40, 260, 280, 80);

    // окна со светом
    for (let i = 0; i < 7; i++) {
        ctx.fillStyle = "#ffd966";
        ctx.fillRect(60 + i * 40, 285, 12, 16);
    }
}

// ───── СНЕГ ─────
function spawnSnow() {
    snowflakes.push({
        x: Math.random() * canvas.width,
        y: -5,
        speed: 0.5 + Math.random(),
        size: 1 + Math.random() * 2
    });
}

function drawSnow() {
    ctx.fillStyle = "white";
    snowflakes.forEach(f => ctx.fillRect(f.x, f.y, f.size, f.size));
}

// ───── СУГРОБЫ ─────
function drawSnowdrifts() {
    ctx.fillStyle = "#e0f2ff";
    ctx.beginPath();
    ctx.moveTo(0, canvas.height);
    ctx.lineTo(0, canvas.height - 40);
    ctx.arc(90, canvas.height - 40, 90, Math.PI, 0);
    ctx.arc(270, canvas.height - 40, 90, Math.PI, 0);
    ctx.lineTo(canvas.width, canvas.height);
    ctx.closePath();
    ctx.fill();
}

// ───── ПЕРСОНАЖ ─────
function drawPlayer() {
    const x = player.x;
    const y = player.y;

    // голова
    ctx.fillStyle = "#f1c27d";
    ctx.fillRect(x + 10, y - 32, 20, 20);

    // волосы
    ctx.fillStyle = "#222";
    ctx.fillRect(x + 10, y - 32, 20, 6);

    // глаза
    ctx.fillRect(x + 14, y - 22, 2, 2);
    ctx.fillRect(x + 24, y - 22, 2, 2);

    // нос
    ctx.fillRect(x + 20, y - 20, 2, 4);

    // усы
    ctx.fillRect(x + 14, y - 16, 16, 2);

    // рот
    ctx.fillRect(x + 18, y - 12, 4, 1);

    // шарф
    ctx.fillStyle = "#b00020";
    ctx.fillRect(x + 4, y - 8, 32, 8);

    // пальто
    ctx.fillStyle = "#3a3a3a";
    ctx.fillRect(x + 4, y, 32, 48);

    // брюки
    ctx.fillStyle = "#1c1c1c";
    ctx.fillRect(x + 8, y + 48, 10, 26);
    ctx.fillRect(x + 22, y + 48, 10, 26);

    // ботинки
    ctx.fillStyle = "#000";
    ctx.fillRect(x + 6, y + 74, 12, 8);
    ctx.fillRect(x + 22, y + 74, 12, 8);
}

// ───── МАНДАРИН ─────
function spawnMandarin() {
    mandarins.push({
        x: Math.random() * (canvas.width - 20),
        y: -20,
        speed: 1.5 + Math.random()
    });
}

function drawMandarin(m) {
    const cx = m.x + 10;
    const cy = m.y + 10;

    const grad = ctx.createRadialGradient(cx-3, cy-3, 2, cx, cy, 10);
    grad.addColorStop(0, "#ffcc80");
    grad.addColorStop(1, "#f57c00");

    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.arc(cx, cy, 9, 0, Math.PI * 2);
    ctx.fill();
}

// ───── ЖИЗНИ ─────
function drawLives() {
    for (let i = 0; i < lives; i++) {
        ctx.fillStyle = "#0a5";
        ctx.beginPath();
        ctx.moveTo(300 + i * 12, 20);
        ctx.lineTo(294 + i * 12, 34);
        ctx.lineTo(306 + i * 12, 34);
        ctx.fill();
    }
}

// ───── ЛОГИКА ─────
function update() {
    if (!gameStarted || gameOver) return;

    if (keys["ArrowLeft"]) player.x -= player.speed;
    if (keys["ArrowRight"]) player.x += player.speed;
    if (keys["ArrowUp"]) player.y -= player.speed / 2;
    if (keys["ArrowDown"]) player.y += player.speed / 2;

    player.x = Math.max(0, Math.min(canvas.width - player.w, player.x));
    player.y = Math.max(260, Math.min(canvas.height - player.h, player.y));

    if (Math.random() < 0.03) spawnMandarin();
    if (Math.random() < 0.2) spawnSnow();

    mandarins.forEach((m, i) => {
        m.y += m.speed;

        if (
            m.x < player.x + player.w &&
            m.x + 20 > player.x &&
            m.y < player.y + player.h &&
            m.y + 20 > player.y
        ) {
            mandarins.splice(i, 1);
            score++;
        } else if (m.y > canvas.height) {
            mandarins.splice(i, 1);
            lives--;
            if (lives <= 0) gameOver = true;
        }
    });

    snowflakes.forEach((s, i) => {
        s.y += s.speed;
        if (s.y > canvas.height) snowflakes.splice(i, 1);
    });
}

// ───── ОТРИСОВКА ─────
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    drawCathedral();
    drawSnow();
    mandarins.forEach(drawMandarin);
    drawPlayer();
    drawSnowdrifts();
    drawLives();

    ctx.fillStyle = "white";
    ctx.fillText("Мандарины: " + score, 10, 20);

    if (!gameStarted) {
        ctx.fillStyle = "rgba(0,0,0,0.7)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        ctx.fillText("Ваша цель — поймать все мандарины.", 180, 220);
        ctx.fillText("Управляйте петербуржцем клавишами", 180, 240);
        ctx.fillText("↑ ↓ ← →", 180, 260);
        ctx.fillText("Нажмите на экран, чтобы начать игру", 180, 300);
    }

    if (gameOver) {
        ctx.fillStyle = "rgba(0,0,0,0.7)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "white";
        ctx.fillText(
            "Вы не смогли съесть все мандарины,",
            180, 240
        );
        ctx.fillText(
            "отдайте часть родственникам и друзьям.",
            180, 260
        );
        ctx.fillText("Собрано: " + score, 180, 290);
        ctx.fillText("Нажмите для рестарта", 180, 330);
    }
}

// ───── КЛИК ─────
canvas.addEventListener("click", () => {
    if (!gameStarted) gameStarted = true;
    else if (gameOver) resetGame();
});

// ───── ЦИКЛ ─────
function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>

